{% extends "base.html" %}

{% block title %}Edit Object {{ obj.id }} - IdeaV{% endblock %}

{% block extra_css %}
<style>
label {
    font-size: 90%;
    color: gray;
    display: inline;
    margin-top: .5rem;
    margin-bottom: 0;
}
.dict-title{
    padding: 20px 0 10px 0;
    font-size: 24px;
    line-height: 24px;
    color: #172D4E;
    display: block;
}
.comp-control {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
}
.hidden { display:none; }
.btn-xs {
    padding: 1px 5px;
    line-height: 1.5;
    border-radius: 3px;
}
input[type=checkbox] {
    width: 38px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
<div id="messages" class="msgs" onclick="this.innerHTML=''"></div>
<div class="row p-1">
<div class="col-12 col-lg-10 col-xl-8" style="min-width: 348px;">
<FORM id="form" method="post" action="/{{ db_name }}/edit_obj/{{ obj.id }}" ENCTYPE="multipart/form-data">
<input type="hidden" name="_xsrf" value="{{ session.xsrf_token or '' }}">
    <div class="dict-title">
        {{ obj.val }} <font color="lightgray" onclick="copyId({{ obj.id }})">#{{ obj.id }} <span id="copied" style="display:none;" class="text-nowrap">(copied)</span></font>
    </div>

    <div class="form-row no-gutters">
    {% for child in children %}
        <label for="t{{ child.field_type }}">Field {{ child.field_type }}</label>

        {% if child.base_type == 'REFERENCE' %}
        <!-- Reference field with autocomplete -->
        <div class="comp-control pb-3 col-12 col-sm-8 col-md-6">
            <div class="form-group" style="display: flex; margin-bottom: 0">
                <select id="t{{ child.field_type }}" name="t{{ child.field_type }}" class="form-control ref-select" data-target-type="{{ child.ref_target_type }}" data-field-type="{{ child.field_type }}">
                    <option value=""> </option>
                    {% if child.ref_value_id %}
                    <option value="{{ child.ref_value_id }}" selected>{{ child.ref_display_val }}</option>
                    {% endif %}
                    {% for option in child.ref_options %}
                    {% if option.id != child.ref_value_id %}
                    <option value="{{ option.id }}">{{ option.val }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <input class="form-control ml-2 ref-search" type="text" placeholder="Search..." data-field-type="{{ child.field_type }}" data-target-type="{{ child.ref_target_type }}">
            </div>
            {% if child.ref_value_id %}
            <div class="mt-1">
                <a href="/{{ db_name }}/edit_obj/{{ child.ref_value_id }}" target="_blank" class="text-sm">→ View {{ child.ref_display_val }}</a>
            </div>
            {% endif %}
        </div>
        {% elif child.base_type == 'FILE' or child.field_type == 10 %}
        <!-- File field -->
        <div class="pb-3 col-12 col-sm-9 col-md-6 pt-1">
            {% if child.val %}
            <span class="file-{{ child.field_type }}">Current: {{ child.val }}</span>
            {% endif %}
            <input class="form-control-file mt-2" type="file" id="t{{ child.field_type }}" name="t{{ child.field_type }}">
        </div>
        {% elif child.base_type == 'BOOLEAN' or child.field_type == 11 %}
        <!-- Checkbox field -->
        <div class="comp-control pb-3 col-6 col-sm-4 col-md-3">
            <input class="form-control" type="checkbox" id="t{{ child.field_type }}" name="t{{ child.field_type }}" value="1" {% if child.val %}checked{% endif %}/>
            <input type="hidden" name="b{{ child.field_type }}" value="1">
        </div>
        {% elif child.base_type == 'MEMO' or child.field_type == 12 %}
        <!-- Textarea field -->
        <div class="comp-control pb-3 col-12">
            <TEXTAREA class="form-control" id="t{{ child.field_type }}" name="t{{ child.field_type }}" rows="5">{{ child.val }}</TEXTAREA>
        </div>
        {% else %}
        <!-- Default text field -->
        <div class="comp-control pb-3 col-12 col-sm-4 col-md-3">
            <input class="form-control" type="text" id="t{{ child.field_type }}" name="t{{ child.field_type }}" value="{{ child.val }}">
        </div>
        {% endif %}
    {% endfor %}
    </div>

    <div id="buttons" class="pt-3 pb-2">
        <A HREF="/{{ db_name }}/object/{{ obj.up }}"><button type="button" class="btn btn-secondary btn-sm mb-1 mr-1">Back</button></A>
    </div>

    <div class="row" style="padding: 0 5px 5px 15px;">
        <div class="col-6 col-sm-4 col-md-3 col-xl-3 p-0 pr-2 copy-dub">
            <input id="savebtn" type="submit" name="savebtn" class="btn btn-primary btn-block mb-2" value="Save">
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-xl-3 p-0 pr-2 undo-btn">
            <A HREF="/{{ db_name }}/object/{{ obj.up }}"><button type="button" class="btn btn-outline-secondary btn-block mb-2">Cancel</button></A>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-xl-3 p-0 pr-2 del-btn">
            <button type="button" class="btn btn-warning btn-block mb-2" onclick="$('.copy-dub').hide(); $('.undo-btn, .del-btn').hide(); $('.confirm-del').show();">Delete</button>
        </div>
    </div>

    <div class="confirm-del" style="display:none; border:2px #f0ad4e solid; border-radius:10px; padding:6px;">
        <p><b>Confirm to delete {{ obj.val }}</b></p>
        <div class="row" style="padding: 0 5px 5px 15px;">
            <div class="col-6 col-sm-4 col-md-3 col-xl-3 p-0 pr-2">
                <button type="button" class="btn btn-warning btn-block mb-2" onclick="post('_m_del/{{ obj.id }}')">Yes, delete</button>
            </div>
            <div class="col-6 col-sm-4 col-md-3 col-xl-3 p-0 pr-2">
                <button type="button" class="btn btn-outline-secondary btn-block mb-2" onclick="$('.copy-dub').show(); $('.undo-btn, .del-btn').show(); $('.confirm-del').hide();">Cancel</button>
            </div>
        </div>
    </div>
</FORM>
</div>
</div>

<script>
function copyId(i){
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val(i).select();
    document.execCommand("copy");
    $temp.remove();
    $('#copied').show().delay(2500).slideUp(400);
}

$(document).ready(function(){
    $('#t{{ obj.t }}').focus();

    // Reference field autocomplete functionality
    $('.ref-search').on('input', function() {
        var searchInput = $(this);
        var searchTerm = searchInput.val();
        var fieldType = searchInput.data('field-type');
        var targetType = searchInput.data('target-type');
        var selectBox = $('#t' + fieldType);

        if (searchTerm.length < 1) {
            return;
        }

        // Debounce search
        clearTimeout(searchInput.data('timeout'));
        var timeout = setTimeout(function() {
            // Call AJAX endpoint
            $.ajax({
                url: '/{{ db_name }}/api/ref_search/' + targetType,
                data: { q: searchTerm },
                dataType: 'json',
                success: function(data) {
                    // Clear existing options except the selected one
                    var selectedValue = selectBox.val();
                    var selectedText = selectBox.find('option:selected').text();
                    selectBox.empty();
                    selectBox.append($('<option>', { value: '', text: ' ' }));

                    // Re-add selected option if it exists
                    if (selectedValue) {
                        selectBox.append($('<option>', {
                            value: selectedValue,
                            text: selectedText,
                            selected: true
                        }));
                    }

                    // Add search results
                    $.each(data, function(index, item) {
                        if (item.id != selectedValue) {
                            selectBox.append($('<option>', {
                                value: item.id,
                                text: item.val
                            }));
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching reference options:', error);
                }
            });
        }, 300); // 300ms debounce

        searchInput.data('timeout', timeout);
    });

    // Update link when reference selection changes
    $('.ref-select').on('change', function() {
        var selectBox = $(this);
        var fieldType = selectBox.data('field-type');
        var selectedId = selectBox.val();
        var selectedText = selectBox.find('option:selected').text();
        var linkContainer = selectBox.closest('.comp-control').find('.mt-1');

        if (selectedId && selectedText.trim() !== '') {
            var link = '<a href="/{{ db_name }}/edit_obj/' + selectedId + '" target="_blank" class="text-sm">→ View ' + selectedText + '</a>';
            if (linkContainer.length > 0) {
                linkContainer.html(link);
            } else {
                selectBox.closest('.comp-control').append('<div class="mt-1">' + link + '</div>');
            }
        } else {
            linkContainer.remove();
        }
    });
});
</script>
</div>
{% endblock %}
